# 診所排班系統 🏥

一個使用 Streamlit 建立的診所排班應用程式，支援 DFS 和 OR-Tools 演算法自動生成符合條件的排班表。

## 目錄

- [功能特點](#功能特點)
- [快速開始](#快速開始)
- [安裝步驟](#安裝步驟)
- [Google Sheets API 設定](#google-sheets-api-設定)
- [使用說明](#使用說明)
- [專案結構](#專案結構)
- [技術細節](#技術細節)
- [員工可上班時間格式](#員工可上班時間格式)
- [常見問題](#常見問題)

---

## 功能特點

### 🎯 核心功能
- **自動排班**: 使用 DFS (深度優先搜尋) 或 OR-Tools CP-SAT 演算法生成所有可能的排班方案
- **條件約束**: 
  - 每班人數、Leader 數、打針人員數等要求
  - 正職員工每週 10 診、每週休 2 天
  - 週一和週五早上需要 4 人（其他班次 3 人）
  - 員工可上班時間限制
- **請假管理**: 支援員工請假申請，排班時自動避開
- **預先排班**: 可手動指定特定員工的特定班次
- **條件放寬**: 當找不到符合所有條件的方案時，可選擇放寬條件重新搜尋
- **排班儲存**: 可將已生成的排班儲存到 Google Sheets，並載入之前的排班

### 👥 權限管理
- **一般使用者**: 可查看排班表（無須登入）
- **管理員**: 可修改設定、員工名單、生成排班（需登入）

### 📊 資料儲存
- 使用 Google Sheets 作為資料庫
- 包含 5 個工作表：
  1. 設定檔 - 班次需求設定
  2. 員工名單 - 員工資訊
  3. 管理員 - 管理員帳密
  4. 請假 - 請假申請記錄
  5. 已排班 - 預先排班記錄

---

## 快速開始

這是一個快速設定和測試診所排班系統的 5 分鐘指南。

### 第一步：安裝相依套件

```bash
pip install -r requirements.txt
```

### 第二步：設定 Google Sheets API

1. 前往 [Google Cloud Console](https://console.cloud.google.com/)
2. 建立專案並啟用 Google Sheets API 和 Google Drive API
3. 建立服務帳戶並下載憑證為 `credentials.json`
4. 建立 Google 試算表並與服務帳戶共用

詳細設定請參考 [Google Sheets API 設定](#google-sheets-api-設定) 章節。

### 第三步：準備最小測試資料

建立一個 Google 試算表，包含 5 個工作表，並填入以下測試資料：

#### Sheet 1: 設定檔（至少 4 名員工）

```
姓名,Leader,打針,可上班時間,正職
張三,TRUE,FALSE,"早,中,晚",TRUE
李四,FALSE,TRUE,"1:早,中;2:早,中;3:早,中;4:早,中;5:早,中",TRUE
王五,TRUE,TRUE,"早,中,晚",TRUE
趙六,FALSE,FALSE,"6:早,中,晚;7:早,中,晚",FALSE
```

其他工作表參考[完整設定](#準備-google-試算表)。

### 第四步：執行應用程式

```bash
streamlit run app.py
```

### 第五步：測試功能

1. 輸入試算表 ID 並連線
2. 登入管理員（帳號：admin，密碼：admin123）
3. 新增請假或預排班
4. 生成排班表
5. 查看日曆視圖

---

## 安裝步驟

### 1. 安裝相依套件

```bash
pip install -r requirements.txt
```

**套件清單**:
- streamlit
- gspread
- oauth2client
- pandas
- python-dateutil
- ortools

### 2. 設定 Google Sheets API

請參考下方的 [Google Sheets API 設定](#google-sheets-api-設定) 完整說明。

### 3. 準備 Google 試算表

建立一個新的 Google 試算表，包含以下 5 個工作表：

#### Sheet 1: 設定檔
| 星期 | 班次 | 人數 | Leader數 | 打針數 | Leader或打針數 |
|------|------|------|----------|--------|----------------|
| 1 | 早 | 4 | 1 | 1 | 2 |
| 1 | 中 | 3 | 1 | 1 | 2 |
| 1 | 晚 | 3 | 1 | 1 | 2 |
| 2 | 早 | 3 | 1 | 1 | 2 |
| ... | ... | ... | ... | ... | ... |

**說明**: 
- 星期：1=週一, 2=週二, ..., 7=週日
- 班次：早/中/晚

#### Sheet 2: 員工名單
| 姓名 | Leader | 打針 | 可上班時間 | 正職 |
|------|--------|------|-----------|------|
| 張三 | TRUE | FALSE | 早,中,晚 | TRUE |
| 李四 | FALSE | TRUE | 1:早,中;2:早;5:早,晚 | FALSE |
| ... | ... | ... | ... | ... |

**可上班時間格式**：
- **簡化格式**（全週相同）: `早,中,晚` 表示全週都可上早中晚班
- **詳細格式**（指定星期）: `1:早,中;2:早;5:早,晚`
  - 數字：1=週一, 2=週二, ..., 7=週日
  - 例如：`1:早,中,晚;5:早,晚` = 週一可上早中晚，週五可上早晚
  - 用分號 `;` 分隔不同星期

詳細說明請參考[員工可上班時間格式](#員工可上班時間格式)章節。

#### Sheet 3: 管理員
| 帳號 | 密碼 |
|------|------|
| admin | admin123 |

#### Sheet 4: 請假
| 員工 | 日期 | 班次 |
|------|------|------|

#### Sheet 5: 已排班
| 員工 | 日期 | 班次 |
|------|------|------|

### 4. 執行應用程式

```bash
streamlit run app.py
```

---

## Google Sheets API 設定

### 步驟 1: 建立 Google Cloud 專案

1. 前往 [Google Cloud Console](https://console.cloud.google.com/)
2. 點擊「選取專案」→「新增專案」
3. 輸入專案名稱（例如：clinic-scheduler）
4. 點擊「建立」

### 步驟 2: 啟用 Google Sheets API

1. 在左側選單中，選擇「API 和服務」→「程式庫」
2. 搜尋「Google Sheets API」
3. 點擊進入並點擊「啟用」
4. 同樣方式啟用「Google Drive API」

### 步驟 3: 建立服務帳戶

1. 在左側選單中，選擇「API 和服務」→「憑證」
2. 點擊「建立憑證」→「服務帳戶」
3. 填寫服務帳戶詳細資訊：
   - 服務帳戶名稱：clinic-scheduler
   - 服務帳戶 ID：會自動生成
4. 點擊「建立並繼續」
5. 角色選擇「編輯者」
6. 點擊「繼續」→「完成」

### 步驟 4: 下載憑證金鑰

1. 在憑證頁面，找到剛建立的服務帳戶
2. 點擊服務帳戶電子郵件
3. 切換到「金鑰」標籤
4. 點擊「新增金鑰」→「建立新金鑰」
5. 選擇「JSON」格式
6. 點擊「建立」，會自動下載 JSON 檔案
7. **將下載的檔案重新命名為 `credentials.json` 並放到專案根目錄**

### 步驟 5: 共用試算表

1. 開啟 `credentials.json`，找到 `client_email` 欄位（類似 `xxx@xxx.iam.gserviceaccount.com`）
2. 在 Google 試算表中，點擊「共用」
3. 將服務帳戶電子郵件加入，權限設為「編輯者」

### 步驟 6: 取得試算表 ID

1. 開啟你的 Google 試算表
2. 複製 URL 中的試算表 ID
   - URL 格式：`https://docs.google.com/spreadsheets/d/[SPREADSHEET_ID]/edit`
3. 在執行應用程式時，需要輸入此 ID

---

## 使用說明

### 首次使用

1. 啟動應用程式後，系統會要求輸入 Google 試算表 ID
2. 從試算表 URL 中複製 ID：`https://docs.google.com/spreadsheets/d/[ID]/edit`
3. 輸入後點擊「連線」

### 管理員功能

1. **登入**: 在側邊欄輸入管理員帳密
2. **員工管理**: 新增、編輯員工資訊
3. **班次設定**: 設定每週各班次的人員需求
4. **生成排班**: 設定請假、預排班後生成排班表

### 生成排班流程

1. 輸入請假申請（員工、日期、班次）
2. 輸入預先排班（必須排的員工和班次）
3. 設定排班參數（開始日期、週數、最多結果數、選擇演算法）
4. 點擊「生成排班表」
5. 如果找不到方案，可選擇放寬條件重新生成
6. 從多個方案中選擇最合適的
7. 可選擇儲存排班到 Google Sheets

### 條件放寬選項

當無法找到符合所有條件的方案時，可選擇：

- **放寬班次需求**: Leader/打針人數減半
- **放寬正職班次數**: 允許每週 8-10 班（而非嚴格 10 班）
- **放寬休假天數**: 允許每週只休 1 天（而非嚴格 2 天）

---

## 專案結構

```
clinic/
├── 📄 app.py                      # 主應用程式（Streamlit）
├── 📄 requirements.txt            # Python 套件相依性
├── 🔑 credentials.json           # Google Sheets API 憑證（需自行建立）
├── 📄 config.py                   # 設定檔（試算表 ID）
├── 📄 config.example.py          # 設定範例
├── 📖 README.md                   # 本說明文件
│
├── 📂 data/                      # 資料層
│   ├── __init__.py
│   ├── models.py                 # 資料模型
│   └── sheets_manager.py         # Google Sheets 管理
│
├── 📂 scheduler/                 # 排班引擎
│   ├── __init__.py
│   ├── constraints.py            # 約束條件驗證
│   └── ortools_scheduler.py      # OR-Tools 排班演算法
│
└── 📂 ui/                        # UI 元件
    ├── __init__.py
    ├── calendar_view.py          # 日曆視圖
    ├── admin_panel.py            # 管理員面板
    └── schedule_generator.py     # 排班生成器
```

### Google Sheets 結構

```
[您的診所排班試算表]
│
├── 📊 Sheet 1: 設定檔
│   └── 星期 | 班次 | 人數 | Leader數 | 打針數 | Leader或打針數
│
├── 📊 Sheet 2: 員工名單
│   └── 姓名 | Leader | 打針 | 可上班時間 | 正職
│
├── 📊 Sheet 3: 管理員
│   └── 帳號 | 密碼
│
├── 📊 Sheet 4: 請假
│   └── 員工 | 日期 | 班次
│
└── 📊 Sheet 5: 已排班
    └── 員工 | 日期 | 班次
```

### 資料流向

```
使用者輸入
    ↓
Streamlit UI (app.py)
    ↓
SheetsManager (data/)
    ↓
Google Sheets ←→ Scheduler (scheduler/)
    ↓                    ↓
載入資料            生成排班方案
    ↓                    ↓
顯示 UI ←────── 返回結果
```

---

## 技術細節

### 核心技術棧

- **前端**: Streamlit (Python web framework)
- **資料庫**: Google Sheets API
- **演算法**: OR-Tools CP-SAT Solver
- **資料結構**: Python dataclass
- **狀態管理**: Streamlit session state
- **權限控制**: 帳密驗證 + session state

### 排班演算法

系統支援兩種演算法：

#### 1. OR-Tools CP-SAT (推薦)
- 使用 Google OR-Tools 的 CP-SAT 約束規劃求解器
- 高效能，適合複雜約束
- 可在合理時間內找到最優解

#### 2. DFS (深度優先搜尋)
- 使用回溯法的深度優先搜尋
- 早期剪枝優化效能
- 限制最多返回 N 個有效方案
- 按偏好分數排序

### 約束條件

排班系統需滿足以下約束：

1. **班次需求**: 每班人數、Leader 數、打針人員數
2. **正職約束**: 每週 10 診、每週休 2 天
3. **可用性**: 員工可上班時間、請假限制
4. **預排班**: 必須包含預先指定的員工
5. **每日限制**: 每人每天最多 3 班（避免過勞）

### 約束條件層級

```
┌──────────────────────────────────────┐
│  Level 1: 班次層級約束                │
│  - 人數正確                            │
│  - Leader 數量足夠                     │
│  - 打針人員數量足夠                    │
│  - 預排班員工必須包含                  │
└──────────────────────────────────────┘
                 │
                 ▼
┌──────────────────────────────────────┐
│  Level 2: 員工層級約束                │
│  - 員工可上班時間符合                  │
│  - 沒有請假衝突                        │
│  - 每天最多 3 班                       │
└──────────────────────────────────────┘
                 │
                 ▼
┌──────────────────────────────────────┐
│  Level 3: 週層級約束（正職）          │
│  - 每週 10 診                          │
│  - 每週休 2 天                         │
└──────────────────────────────────────┘
```

### 偏好評分

- 同一天上兩班：+10 分
- 同一天上一班：+0 分
- 同一天上三班：-5 分（懲罰）

---

## 員工可上班時間格式

### 格式說明

員工的「可上班時間」欄位支援兩種格式：

#### 1. 簡化格式（全週相同）

如果員工全週都可上相同的班次，使用逗號分隔的簡單列表：

```
早,中,晚      # 全週都可上早中晚班
早,中          # 全週都可上早中班（不上晚班）
早,晚          # 全週都可上早晚班（不上中班）
```

#### 2. 詳細格式（指定星期幾）

如果員工在不同星期可上的班次不同，使用詳細格式：

```
1:早,中,晚;2:早,中;5:早,晚
```

**格式說明**：
- 數字代表星期：`1`=週一, `2`=週二, `3`=週三, `4`=週四, `5`=週五, `6`=週六, `7`=週日
- 冒號 `:` 分隔星期和班次
- 逗號 `,` 分隔同一天的不同班次
- 分號 `;` 分隔不同星期

### 範例

#### 範例 1：全職員工（全週可上班）

```
早,中,晚
```

表示：全週都可上早、中、晚班

#### 範例 2：平日員工（只在週一到週五）

```
1:早,中,晚;2:早,中,晚;3:早,中,晚;4:早,中,晚;5:早,中,晚
```

表示：週一到週五可上早中晚班，週末不上班

#### 範例 3：週末員工（只在週六週日）

```
6:早,中,晚;7:早,中,晚
```

表示：只在週六和週日上班，可上早中晚班

#### 範例 4：特定星期特定班次

```
1:早;3:早;5:早,晚
```

表示：
- 週一只上早班
- 週三只上早班
- 週五可上早班和晚班
- 其他日子不上班

#### 範例 5：兼職員工（不固定時間）

```
1:早,中;2:早;4:晚;6:早,中,晚
```

表示：
- 週一：可上早、中班
- 週二：只能上早班
- 週四：只能上晚班
- 週六：可上早、中、晚班
- 週三、週五、週日：不上班

### 在 UI 中編輯

在 Streamlit 應用程式的「員工管理」頁面，您可以：

1. **使用快速設定**：
   - 全週全時段
   - 全週早中班
   - 全週早晚班
   - 平日全時段（週一到週五）
   - 週末全時段（週六、週日）

2. **詳細設定**：
   使用表格形式的核取方塊，針對每個星期的每個班次個別設定

### 進階使用情境

#### 情境 1：學生工讀生（只在特定日子）

```
2:晚;4:晚;6:早,中,晚;7:早,中,晚
```

平日晚上 + 週末全天

#### 情境 2：彈性工作（早上有空閒）

```
1:早;2:早;3:早;4:早;5:早;6:早;7:早
```

全週只上早班

#### 情境 3：輪班制（特定星期特定時段）

```
1:早,中;2:中,晚;3:早,中;4:中,晚;5:早,中
```

平日輪流上不同班次

### 常見問題

**Q: 如果員工某天完全不上班，需要寫什麼嗎？**

A: 不需要。只需要列出可以上班的星期即可，沒有列出的星期會自動視為不上班。

**Q: 可以混用簡化格式和詳細格式嗎？**

A: 不可以。每個員工只能使用一種格式。系統會自動偵測格式（有冒號 `:` 就是詳細格式）。

**Q: 排班時會考慮星期幾嗎？**

A: 會！排班演算法在分配員工時，會檢查員工是否能在該星期的那個班次上班。

---

## 常見問題

### Q: 為什麼找不到排班方案？

可能原因：
1. 員工人數不足（建議至少 4-6 人）
2. 請假太多
3. 正職員工無法滿足每週 10 診
4. 預排班衝突

建議：使用條件放寬功能重新生成

### Q: 如何修改管理員密碼？

直接在 Google 試算表的「管理員」工作表中修改，重新載入即可。

### Q: 可以排多久的班表？

預設為 4 週（一個月），可在生成時調整為 1-8 週。

### Q: 無法連線到 Google Sheets？

解決方法：
1. 檢查 `credentials.json` 是否在專案根目錄
2. 檢查試算表是否已與服務帳戶共用
3. 確認試算表 ID 正確
4. 確認工作表名稱正確（設定檔、員工名單、管理員、請假、已排班）

### Q: OR-Tools 和 DFS 該選哪個？

- **OR-Tools**: 推薦使用，速度快、效能好，適合複雜約束
- **DFS**: 適合小規模排班或學習演算法原理

### Q: 如何診斷連線問題？

系統提供診斷功能，可列出所有工作表名稱，幫助診斷問題。

---

## 主要特色

✅ 完全自動化排班（OR-Tools / DFS 演算法）  
✅ 多種約束條件支援  
✅ 條件放寬機制  
✅ 請假與預排班管理  
✅ 管理員權限控制  
✅ 直覺的日曆視圖  
✅ Google Sheets 整合  
✅ 排班儲存與載入功能  
✅ 完整文件說明

---

## 未來改進方向

1. **功能擴展**
   - 匯出排班表為 PDF/Excel
   - 排班歷史記錄和版本控制
   - 員工偏好設定
   - 自動通知員工排班結果

2. **演算法改進**
   - 使用機器學習優化排班品質
   - 支援更複雜的約束條件
   - 多目標優化（公平性、員工滿意度等）

3. **UI/UX 改進**
   - 響應式設計（手機版）
   - 拖放式排班編輯
   - 即時預覽和驗證
   - 更豐富的視覺化（統計圖表）

4. **部署和維運**
   - Docker 容器化
   - 自動部署流程
   - 日誌和監控
   - 備份和復原機制

---

## 授權

此專案僅供學習和內部使用。

## 聯絡方式

如有問題或建議，請聯絡開發團隊。
